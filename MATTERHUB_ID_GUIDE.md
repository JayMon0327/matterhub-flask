# matterhub_id ë°œê¸‰ ë° ì„¤ì • ê°€ì´ë“œ

`matterhub_id`ëŠ” **Claim í”„ë¡œë¹„ì €ë‹**ì„ í†µí•´ AWS IoT Coreì—ì„œ ë°œê¸‰ë˜ëŠ” **thingName**ì…ë‹ˆë‹¤.  
**í…ŒìŠ¤íŠ¸ í† í”½(KONAI_TEST_TOPIC)** ì‘ë‹µ ë° ë ˆê±°ì‹œ `matterhub/*` í† í”½ êµ¬ë…ì— í•„ìš”í•©ë‹ˆë‹¤.

**í•œ ì¤„ ìš”ì•½:** ë°œê¸‰ í™•ì¸ â†’ ë¡œê·¸ì˜ `ğŸ“‹ matterhub_id:` / ë°œê¸‰ â†’ `python run_provision.py` / .env ë“±ë¡ â†’ í”„ë¡œë¹„ì €ë‹ ì‹œ ìë™ ë˜ëŠ” ìˆ˜ë™ ì¶”ê°€ / í…ŒìŠ¤íŠ¸ â†’ ì¬ì‹œì‘ í›„ í…ŒìŠ¤íŠ¸ í† í”½ ìš”ì²­Â·ì‘ë‹µì—ì„œ `hub_id` í™•ì¸

---

## 1. í˜„ì¬ ë°œê¸‰ ì—¬ë¶€ í™•ì¸

### 1.1 MQTT ë¡œê·¸ì—ì„œ í™•ì¸ (ê°€ì¥ ì§ê´€ì )

`mqtt.py` ì‹¤í–‰ í›„ **í† í”½ êµ¬ë… ì§ì „**ì— ë‹¤ìŒ í•œ ì¤„ì´ ì¶œë ¥ë©ë‹ˆë‹¤:

- **ë°œê¸‰Â·ë“±ë¡ë¨:** `ğŸ“‹ matterhub_id: whatsmatter-nipa-thing-xxxxx`
- **ë¯¸ë°œê¸‰:** `ğŸ“‹ matterhub_id: (ë¯¸ì„¤ì • â€” Claim í”„ë¡œë¹„ì €ë‹ í›„ .env ë“±ë¡ í•„ìš”, ê°€ì´ë“œ: MATTERHUB_ID_GUIDE.md)`

ì‹œì‘ ì‹œì ì—ë„ ë‹¤ìŒìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ë°œê¸‰ë¨:** `ğŸ“Œ matterhub_id ë¡œë“œë¨: {ë°œê¸‰ëœê°’} (.envì—ì„œ ì½ìŒ)`
- **ë¯¸ë°œê¸‰:** `âš ï¸ matterhub_id ì—†ìŒ â†’ Claim í”„ë¡œë¹„ì €ë‹ ì‹¤í–‰ í›„ .envì— ë“±ë¡í•˜ì„¸ìš”.`

### 1.2 í…ŒìŠ¤íŠ¸ í† í”½ ì‚¬ìš© ì‹œ ë¡œê·¸

í…ŒìŠ¤íŠ¸ í† í”½(`KONAI_TEST_TOPIC_REQUEST`)ìœ¼ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ë¡œê·¸ì— matterhub_idê°€ ì°í™ë‹ˆë‹¤:

- `ğŸ§ª ì½”ë‚˜ì´ í…ŒìŠ¤íŠ¸ ìš”ì²­ ìˆ˜ì‹ : {topic} â†’ ì‘ë‹µ í† í”½: {response_topic}, matterhub_id={ë°œê¸‰ëœê°’ ë˜ëŠ” (ë¯¸ì„¤ì •)}`

í…ŒìŠ¤íŠ¸ êµ¬ë… ìŠ¤ë ˆë“œë¥¼ ì¼  ê²½ìš°(`ENABLE_KONAI_TEST_SUBSCRIBER=1`):

- `ğŸ§ª [TEST] ... í…ŒìŠ¤íŠ¸ êµ¬ë… ìŠ¤ë ˆë“œ ì‹œì‘ (matterhub_id={ë°œê¸‰ëœê°’ ë˜ëŠ” ë¯¸ì„¤ì •})`

### 1.3 .env íŒŒì¼ì—ì„œ í™•ì¸

```bash
grep matterhub_id .env
```

- `matterhub_id="..."` í˜•íƒœë¡œ ê°’ì´ ìˆìœ¼ë©´ ë°œê¸‰Â·ë“±ë¡ ì™„ë£Œ
- ì—†ê±°ë‚˜ ë¹ˆ ê°’ì´ë©´ í”„ë¡œë¹„ì €ë‹ í•„ìš”

### 1.4 í…ŒìŠ¤íŠ¸ í† í”½ ì‘ë‹µ payloadì—ì„œ í™•ì¸

í…ŒìŠ¤íŠ¸ í† í”½ ìš”ì²­ ì‹œ ì‘ë‹µ JSONì— `hub_id`ê°€ í¬í•¨ë©ë‹ˆë‹¤ (matterhub_idê°€ ì„¤ì •ëœ ê²½ìš°):

```json
{
  "type": "query_response_all",
  "correlation_id": "...",
  "ts": "...",
  "hub_id": "ë°œê¸‰ëœ-matterhub-id",
  "data": [...]
}
```

ë¡œê·¸ ì˜ˆ: `âœ… ì½”ë‚˜ì´ ì „ì²´ ì¡°íšŒ ì‘ë‹µ: N entities, hub_id=ë°œê¸‰ëœê°’`

---

## 2. Claim í”„ë¡œë¹„ì €ë‹ìœ¼ë¡œ ë°œê¸‰

### 2.1 ì‚¬ì „ ì¡°ê±´

- `certificates/` ë””ë ‰í„°ë¦¬ì— Claim ì¸ì¦ì„œ ì¡´ì¬:
  - `whatsmatter_nipa_claim_cert.cert.pem`
  - `whatsmatter_nipa_claim_cert.private.key`
- AWS IoT í”„ë¡œë¹„ì €ë‹ í…œí”Œë¦¿ `whatsmatter-nipa-template` ë“±ë¡ ì™„ë£Œ

### 2.2 ë°©ë²• A: ì „ìš© ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê¶Œì¥)

```bash
cd matterhub-flask
python run_provision.py
```

- í”„ë¡œë¹„ì €ë‹ í›„ thingNameì„ matterhub_idë¡œ `.env`ì— ìë™ ì €ì¥
- ì„±ê³µ ì‹œ `âœ… [PROVISION] matterhub_id ë°œê¸‰ ì™„ë£Œ: {ê°’}` ì¶œë ¥

### 2.3 ë°©ë²• B: í…ŒìŠ¤íŠ¸ êµ¬ë…ì í†µí•´ ìë™ ë°œê¸‰

`ENABLE_KONAI_TEST_SUBSCRIBER=1` ì„¤ì • í›„ `mqtt.py` ì‹¤í–‰ ì‹œ:

- device ì¸ì¦ì„œê°€ ì—†ìœ¼ë©´ Claim í”„ë¡œë¹„ì €ë‹ì´ ìë™ ì‹¤í–‰
- ë°œê¸‰ ì™„ë£Œ ì‹œ `.env`ì— ìë™ ì €ì¥

```bash
# .envì— ì¶”ê°€
ENABLE_KONAI_TEST_SUBSCRIBER=1
KONAI_TEST_TOPIC=update/reported/dev/.../matter/test  # í…ŒìŠ¤íŠ¸ í† í”½ (í•„ìš” ì‹œ)
```

> âš ï¸ ì´ ê²½ìš° `mqtt.py`ëŠ” í”„ë¡œë¹„ì €ë‹ ì‹œì ì— ì´ë¯¸ ê¸°ë™ ì¤‘ì´ë¯€ë¡œ, **ì¬ì‹œì‘**í•´ì•¼ ìƒˆ matterhub_idê°€ ì ìš©ë©ë‹ˆë‹¤.

---

## 3. matterhub_id í™•ë³´ í›„ .envì— ë“±ë¡í•˜ëŠ” ë°©ë²•

### 3.1 í”„ë¡œë¹„ì €ë‹ ì„±ê³µ ì‹œ ìë™ ë“±ë¡

`run_provision.py` ë˜ëŠ” ìë™ í”„ë¡œë¹„ì €ë‹ìœ¼ë¡œ ë°œê¸‰ì´ ì„±ê³µí•˜ë©´ **thingName**ì´ matterhub_idë¡œ `.env`ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤:

```
matterhub_id="whatsmatter-nipa-thing-12345"
```

ì½˜ì†”ì— `âœ… [PROVISION] matterhub_id ë°œê¸‰ ì™„ë£Œ: ...` ê°€ ë³´ì´ë©´ .env ë°˜ì˜ê¹Œì§€ ì™„ë£Œëœ ìƒíƒœì…ë‹ˆë‹¤.

### 3.2 ìˆ˜ë™ ë“±ë¡ (ë°œê¸‰ì€ í–ˆëŠ”ë° .envì— ì—†ëŠ” ê²½ìš°)

1. í”„ë¡œë¹„ì €ë‹ìœ¼ë¡œ ë°œê¸‰ëœ **thingName** í™•ì¸ (í”„ë¡œë¹„ì €ë‹ ë¡œê·¸ ë˜ëŠ” AWS IoT ì½˜ì†”)
2. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ `.env` íŒŒì¼ ì—´ê¸°
3. ë‹¤ìŒ ì¤‘ í•˜ë‚˜ ì ìš©:
   - **ì¶”ê°€:** ìƒˆ ì¤„ì— `matterhub_id="ë°œê¸‰ëœ-thingName"` ì…ë ¥
   - **ìˆ˜ì •:** ê¸°ì¡´ `matterhub_id=...` ë¥¼ `matterhub_id="ë°œê¸‰ëœ-thingName"` ìœ¼ë¡œ ë³€ê²½
4. ì €ì¥ í›„ **mqtt.py(ë˜ëŠ” PM2) ì¬ì‹œì‘ í•„ìˆ˜**

```bash
# ì˜ˆì‹œ
echo 'matterhub_id="whatsmatter-nipa-thing-abc12"' >> .env
# ë˜ëŠ”
grep matterhub_id .env   # í™•ì¸
```

### 3.3 ë“±ë¡ í™•ì¸

```bash
grep matterhub_id .env
# matterhub_id="whatsmatter-nipa-thing-..." ê°€ ë³´ì´ë©´ ë“±ë¡ ì™„ë£Œ
```

---

## 4. .env ë“±ë¡ í›„ í…ŒìŠ¤íŠ¸ ë°©ë²•

### 4.1 1ë‹¨ê³„: í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ (í•„ìˆ˜)

`.env`ë¥¼ ìˆ˜ì •í•œ ë’¤ì—ëŠ” **ë°˜ë“œì‹œ** mqtt í”„ë¡œì„¸ìŠ¤ë¥¼ ì¬ì‹œì‘í•´ì•¼ ìƒˆ matterhub_idê°€ ì ìš©ë©ë‹ˆë‹¤.

**PM2 ì‚¬ìš© ì‹œ:**
```bash
pm2 restart wm-mqtt
# ë˜ëŠ”
pm2 restart all
```

**ì§ì ‘ ì‹¤í–‰ ì‹œ:**
```bash
# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›„
python mqtt.py
```

### 4.2 2ë‹¨ê³„: ë¡œê·¸ë¡œ matterhub_id ì ìš© í™•ì¸

ì¬ì‹œì‘ í›„ ì•„ë˜ ë¡œê·¸ê°€ ë³´ì´ë©´ ì •ìƒ ì ìš©ëœ ê²ƒì…ë‹ˆë‹¤.

- `ğŸ“Œ matterhub_id ë¡œë“œë¨: {ë°œê¸‰ëœê°’} (.envì—ì„œ ì½ìŒ)`
- `ğŸ“‹ matterhub_id: {ë°œê¸‰ëœê°’}`  â† **í† í”½ êµ¬ë… ì§ì „ í•œ ì¤„**
- `â¡ï¸ SUBSCRIBE ìš”ì²­: matterhub/{ë°œê¸‰ëœê°’}/api`
- `âœ… SUBSCRIBE ì„±ê³µ: matterhub/{ë°œê¸‰ëœê°’}/api`

`matterhub_id ì—†ìŒ` / `(ë¯¸ì„¤ì •)` ë©”ì‹œì§€ê°€ ì—†ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.

### 4.3 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸ í† í”½ìœ¼ë¡œ ë™ì‘ í™•ì¸

1. **.envì— í…ŒìŠ¤íŠ¸ í† í”½ ì„¤ì •** (ì•„ì§ ì—†ë‹¤ë©´):

   ```
   KONAI_TEST_TOPIC_REQUEST=update/reported/dev/.../matter/test
   KONAI_TEST_TOPIC_RESPONSE=update/reported/dev/.../matter/test
   ```

2. **í…ŒìŠ¤íŠ¸ ìš”ì²­ ë°œí–‰**  
   AWS IoT MQTT í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ `KONAI_TEST_TOPIC_REQUEST`ì— ì•„ë˜ì™€ ê°™ì€ JSON ë°œí–‰:

   ```json
   {"correlation_id": "test-001", "entity_id": ""}
   ```
   ë˜ëŠ” ì „ì²´ ì¡°íšŒ:
   ```json
   {"correlation_id": "test-001"}
   ```

3. **í™•ì¸í•  ê²ƒ**
   - **ë¡œê·¸:** `ğŸ§ª ì½”ë‚˜ì´ í…ŒìŠ¤íŠ¸ ìš”ì²­ ìˆ˜ì‹ : ... matterhub_id={ë°œê¸‰ëœê°’}` ì—ì„œ matterhub_idê°€ ê°’ìœ¼ë¡œ ë‚˜ì˜¤ëŠ”ì§€
   - **ì‘ë‹µ payload:** ìˆ˜ì‹ í•œ JSONì— `"hub_id": "ë°œê¸‰ëœ-matterhub-id"` ê°€ í¬í•¨ë˜ëŠ”ì§€
   - **ë¡œê·¸:** `âœ… ì½”ë‚˜ì´ ì „ì²´ ì¡°íšŒ ì‘ë‹µ: N entities, hub_id={ë°œê¸‰ëœê°’}`

(ì„ íƒ) í…ŒìŠ¤íŠ¸ ìˆ˜ì‹  ì „ìš© êµ¬ë… ìŠ¤ë ˆë“œë¥¼ ì“°ë ¤ë©´ `.env`ì— `ENABLE_KONAI_TEST_SUBSCRIBER=1` ì„¤ì • í›„ ì¬ì‹œì‘í•˜ë©´, í…ŒìŠ¤íŠ¸ í† í”½ ìˆ˜ì‹  ì‹œ ë¡œê·¸ì— `matterhub_id=...` ë„ í•¨ê»˜ ì¶œë ¥ë©ë‹ˆë‹¤.

### 4.4 4ë‹¨ê³„: HTTP APIë¡œ í™•ì¸ (app.py ì‹¤í–‰ ì¤‘ì¼ ë•Œ)

```bash
curl http://localhost:5000/matterhub_id
```

ì˜ˆì‹œ ì‘ë‹µ: `{"matterhub_id":"whatsmatter-nipa-thing-..."}`

---

## 5. ë¬¸ì œ í•´ê²°

| ì¦ìƒ | í™•ì¸ ì‚¬í•­ |
|------|-----------|
| `matterhub_id ì—†ìŒ` ë¡œê·¸ | `.env`ì— `matterhub_id` ì¡´ì¬ ì—¬ë¶€, í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì—¬ë¶€ |
| í”„ë¡œë¹„ì €ë‹ ì‹¤íŒ¨ | Claim ì¸ì¦ì„œ ê²½ë¡œÂ·íŒŒì¼ëª…, AWS í…œí”Œë¦¿ ì„¤ì • |
| í…ŒìŠ¤íŠ¸ ì‘ë‹µì— hub_id ì—†ìŒ | matterhub_id ë¡œë“œ ì—¬ë¶€, ì¬ì‹œì‘ í›„ ì¬í…ŒìŠ¤íŠ¸ |
| ë ˆê±°ì‹œ í† í”½ ë¯¸êµ¬ë… | matterhub_id ì„¤ì • í›„ ì¬ì‹œì‘ |

---

## 6. ìš”ì•½

| ë‹¨ê³„ | ë°©ë²• |
|------|------|
| **1. ë°œê¸‰ ì—¬ë¶€ í™•ì¸** | MQTT ë¡œê·¸ì˜ `ğŸ“‹ matterhub_id: ...` í•œ ì¤„ ë˜ëŠ” `grep matterhub_id .env` |
| **2. ë°œê¸‰** | `python run_provision.py` (ê¶Œì¥) ë˜ëŠ” ENABLE_KONAI_TEST_SUBSCRIBER=1ë¡œ ìë™ ë°œê¸‰ |
| **3. .env ë“±ë¡** | í”„ë¡œë¹„ì €ë‹ ì„±ê³µ ì‹œ ìë™ ì €ì¥ë¨. ì—†ìœ¼ë©´ `matterhub_id="thingName"` ìˆ˜ë™ ì¶”ê°€ |
| **4. í…ŒìŠ¤íŠ¸** | mqtt.py/PM2 ì¬ì‹œì‘ â†’ `ğŸ“‹ matterhub_id: {ê°’}` í™•ì¸ â†’ í…ŒìŠ¤íŠ¸ í† í”½ ìš”ì²­ ì‹œ ë¡œê·¸Â·ì‘ë‹µì— `hub_id` í™•ì¸ |
